services:
  api-gateway:
    build: ./services/api-gateway
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      - PLANNER_GRPC_ADDR=planner:50051
      - RAG_GRPC_ADDR=rag:50052
    depends_on:
      - planner
      - rag

  rag:
    build: ./services/rag
    container_name: rag
    ports:
      - "50052:50052"
    environment:
      - GRPC_PORT=50052
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - CHAT_MODEL=${CHAT_MODEL:-gpt-4o-mini}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - COURSE_DATA_PATH=/app/data/courses.json
      - CHROMA_PATH=/app/data/chroma
    volumes:
      - ./data/courses.json:/app/data/courses.json:ro
      - rag-chroma-data:/app/data/chroma

  planner:
    build: ./services/planner
    container_name: planner
    ports:
      - "50051:50051"
    environment:
      - GRPC_PORT=50051

  auth:
    build: ./services/auth
    container_name: auth
    ports:
      - "8083:8083"
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}

volumes:
  rag-chroma-data:
